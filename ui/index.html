<!DOCTYPE html>
<html>

<meta charset=utf-8>
<meta name=viewport content="width=device-width, height=device-height, user-scalable=no">

<link rel=stylesheet href=style.css>
<script src=https://apprtc.appspot.com/js/adapter.js></script>
<script>
function error(err) {
	console.log("foo:", err)
}

(function () {
	var constraints = {video: true, audio: false}
	var ws = new WebSocket('ws://' + location.host + '/call')
	var cfg = {"iceServers": [{"url": "stun:stun.l.google.com:19302"}]};
	pc = new RTCPeerConnection(cfg, {optional: [{RtpDataChannels: true}]});
	
	ws.onmessage = function(m) {
		var msg = JSON.parse(m.data);
		if (msg.type === 'offer') {
			console.log("got offer", msg)
			pc.setRemoteDescription(new RTCSessionDescription(msg), function(){}, error);
			pc.createAnswer(function(desc) {
				pc.setLocalDescription(desc);
				ws.send(JSON.stringify(desc));
			});
		} else if (msg.type === 'answer') {
			console.log("got answer", msg)
			pc.setRemoteDescription(new RTCSessionDescription(msg), function(){}, error);
		} else if (msg.type === 'candidate') {
			console.log("got candidate", msg)
			pc.addIceCandidate(new RTCIceCandidate(msg));
		} else {
			console.log("what's this?", msg)
		}
	}
	
	pc.onicecandidate = function(e) {
		if (e.candidate) {
			e.candidate.type="candidate";
			console.log("sending candidate", e.candidate)
			ws.send(JSON.stringify(e.candidate));
		}
	}
	pc.onconnecting = function (e) {
		console.log("connecting...", e)
	};
	pc.onopen = function (e) {
		console.log("open!", e)
	};
	pc.onaddstream = function (e) {
		console.log("addStream!", e)
		var vid = document.getElementById("cam");
		attachMediaStream(vid, e.stream);
	};
})();
</script>

<title>webcam</title>
<body>
<video id=cam autoplay>
