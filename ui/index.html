<!DOCTYPE html>
<html>
<meta charset=utf-8>
<meta name=viewport content="width=device-width, height=device-height, user-scalable=no">
<link rel=stylesheet href=style.css>
<script src=sdp.js></script>
<script>
var peerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || 
	window.webkitRTCPeerConnection || window.msRTCPeerConnection;
var sessionDescription = window.RTCSessionDescription || window.mozRTCSessionDescription ||
	window.webkitRTCSessionDescription || window.msRTCSessionDescription;
navigator.getUserMedia = navigator.getUserMedia || navigator.mozGetUserMedia ||
	navigator.webkitGetUserMedia || navigator.msGetUserMedia;

function error(err) {
	console.log("err:", err)
}

var iceCfg = {iceServers: [{urls: "stun:stun.l.google.com:19302"}]};
var mediaConstraints = {offerToReceiveVideo: true};
var pc = new peerConnection(iceCfg, {optional: [{RtpDataChannels: true}]});

function sendOffer(pc) {	
	var req = new XMLHttpRequest();
	req.open('POST', '/session');
	req.onload = function() {
		if (req.status >= 200 && req.status < 400) {
			var answer = SDP.generate(JSON.parse(req.responseText));
			console.log("answer is : " + answer);
			pc.setRemoteDescription(new sessionDescription({type: "answer", sdp: answer}), function(){}, error);
		} else {
			error("server returned error: " + req.status);
		}
	};
	req.onerror = error;
	var offer = JSON.stringify(SDP.parse(pc.localDescription.sdp));
	console.log(offer);
	req.send(offer);
}

var sent = false;

pc.onicecandidate = function(e) {
	if (pc.iceGatheringState === "complete") {
		console.log("finished gathering candidates");
		if (!sent) {
			sendOffer(pc);
			sent = true;
		}
	}
};

pc.onaddstream = function(obj) {
	var vid = document.getElementById("cam");
	vid.srcObject = obj.stream;
};

pc.createOffer(function(desc) {
	pc.setLocalDescription(desc);
	//ws.send(JSON.stringify(desc));
}, error, mediaConstraints);


</script>

<title>webcam</title>
<body>
<video id=cam autoplay>
